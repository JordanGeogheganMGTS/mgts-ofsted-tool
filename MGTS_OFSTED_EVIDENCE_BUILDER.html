<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MGTS Ofsted Evidence Builder & Self-Assessment System</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Ofsted Framework Structure
        const OFSTED_FRAMEWORK = {
          safeguarding: {
            title: "Safeguarding (Whole-Provider Level)",
            type: "binary",
            criteria: [
              "Safeguarding culture established - staff, learners, employers feel comfortable raising concerns",
              "Appropriate safeguarding policies and procedures in place reflecting current statutory guidance",
              "Designated safeguarding lead(s) appropriately trained and effective",
              "Staff training on safeguarding including Prevent duty",
              "Learners taught how to stay safe including online",
              "Multi-agency working and external partnerships established",
              "Safer recruitment procedures followed with single central record maintained",
              "Clear procedures for responding to allegations against staff or peers",
              "Child-on-child violence procedures and support",
              "Safeguarding incidents reviewed to improve practice",
              "Low-level concerns recorded and reviewed"
            ]
          },
          inclusion: {
            title: "Inclusion (Whole-Provider Level)",
            type: "graded",
            grades: ["Needs Attention", "Expected Standard", "Strong Standard", "Exceptional"],
            criteria: [
              "Culture where learners' needs are met and learners feel supported",
              "Quick and accurate identification of learners' learning and support needs",
              "Graduated approach (assess, plan, do, review) implemented effectively",
              "Staff receive suitable training to support diverse needs",
              "High expectations maintained for all learners including those with barriers",
              "Designated SEND leader qualified and effective (where applicable)",
              "Alternative settings/subcontractors monitored for suitability",
              "Additional support regularly reviewed and adapted based on impact",
              "Learners prepared for independence when support reduced",
              "Use of high needs funding appropriate and impactful"
            ]
          },
          leadership: {
            title: "Leadership and Governance (Whole-Provider Level)",
            type: "graded",
            grades: ["Needs Attention", "Expected Standard", "Strong Standard", "Exceptional"],
            criteria: [
              "Leaders understand provider's strengths and areas for development accurately",
              "Leaders take appropriate and timely action to drive improvement",
              "Governors/oversight bodies have clear vision and strategy",
              "Governors provide appropriate support and challenge to leaders",
              "Decisions made in best interests of learners, especially disadvantaged",
              "Governors have accurate understanding of curriculum quality",
              "Leaders have high expectations of all learners and staff",
              "Staff understand and contribute to strategic priorities",
              "Workload and wellbeing of staff monitored and acted upon",
              "Partnerships with stakeholders support learner outcomes",
              "Quality assurance processes robust and lead to improvement"
            ]
          },
          curriculum: {
            title: "Curriculum, Teaching and Training (Provision Type Level)",
            type: "graded",
            grades: ["Needs Attention", "Expected Standard", "Strong Standard", "Exceptional"],
            criteria: [
              "Leaders have accurate understanding of curriculum and teaching quality",
              "Curriculum well sequenced and builds on prior learning",
              "Curriculum relevant to local, regional, national employment priorities",
              "Curriculum accessible for all learners including those with SEND",
              "Teachers/trainers have expert knowledge and skills",
              "Teaching and training effective in helping learners build knowledge and skills",
              "Assessment used effectively to check learning and inform teaching",
              "Feedback helps learners understand how to improve",
              "English and mathematical skills developed throughout curriculum",
              "Digital skills developed appropriately",
              "Teachers adapt curriculum for different learner needs",
              "Additional learning opportunities provided beyond core curriculum"
            ]
          },
          achievement: {
            title: "Achievement (Provision Type Level)",
            type: "graded",
            grades: ["Needs Attention", "Expected Standard", "Strong Standard", "Exceptional"],
            criteria: [
              "Learners make appropriate/extensive progress from starting points",
              "Achievement rates appropriate/high, especially for disadvantaged learners",
              "Learners develop intended knowledge, skills and behaviours",
              "Learners produce work of expected standard for their level",
              "Learners develop English and maths skills needed for progression",
              "Learners ready for next steps in education, employment or training",
              "Learners progress to appropriate destinations",
              "Gaps for disadvantaged learners closing",
              "Individual learning goals and targets set and reviewed",
              "End-point assessment uptake and pass rates appropriate/high"
            ]
          },
          participation: {
            title: "Participation and Development (Provision Type Level)",
            type: "graded",
            grades: ["Needs Attention", "Expected Standard", "Strong Standard", "Exceptional"],
            criteria: [
              "Learners study/work in safe and respectful environments",
              "High expectations for attendance, behaviour and attitudes set",
              "Attendance typically high with prompt action on low attendance",
              "Inappropriate behaviour addressed consistently and promptly",
              "Bullying, discrimination, harassment not tolerated and dealt with effectively",
              "Learners know how to raise concerns and trust staff will act",
              "Pastoral support and wider opportunities appropriate for learner needs",
              "Age-appropriate content on health, relationships, online safety delivered",
              "Learners develop understanding of fundamental British values",
              "Learners understand and respect protected characteristics",
              "Careers education and guidance structured and effective",
              "Work-related learning meets statutory requirements (16-19 study programmes)",
              "Learners develop employability skills and independence"
            ]
          }
        };

        const LucideIcon = ({ name, className = "", size = 24 }) => {
          useEffect(() => {
            lucide.createIcons();
          });
          return React.createElement('i', {
            'data-lucide': name,
            className: className,
            style: { width: size, height: size }
          });
        };

        const OfstedEvidenceBuilder = () => {
          const [activeSection, setActiveSection] = useState('safeguarding');
          const [evidenceData, setEvidenceData] = useState({});
          const [showAddEvidence, setShowAddEvidence] = useState(null);
          const [newEvidence, setNewEvidence] = useState({ description: '', evidence: '', links: '' });
          const [isGenerating, setIsGenerating] = useState(false);
          const [generatedReport, setGeneratedReport] = useState(null);
          const [showReport, setShowReport] = useState(false);
          const [actionPlan, setActionPlan] = useState(null);
          const [activeView, setActiveView] = useState('evidence');
          const [currentUser, setCurrentUser] = useState('');
          const [showUserPrompt, setShowUserPrompt] = useState(false);
          const [lastSaved, setLastSaved] = useState(null);
          const [showBackupReminder, setShowBackupReminder] = useState(false);
          
          // API Key management
          const [apiKey, setApiKey] = useState('');
          const [showApiKeyPrompt, setShowApiKeyPrompt] = useState(true);
          const [tempApiKey, setTempApiKey] = useState('');
          const [showApiKeySettings, setShowApiKeySettings] = useState(false);

          useEffect(() => {
            const savedData = localStorage.getItem('mgts_ofsted_evidence');
            const savedUser = localStorage.getItem('mgts_current_user');
            
            if (savedData) {
              try {
                const parsed = JSON.parse(savedData);
                setEvidenceData(parsed.data);
                setLastSaved(new Date(parsed.timestamp));
              } catch (e) {
                console.error("Error loading saved data:", e);
                initializeData();
              }
            } else {
              initializeData();
            }

            if (savedUser) {
              setCurrentUser(savedUser);
            } else {
              setShowUserPrompt(true);
            }

            const backupCheck = setInterval(() => {
              const lastBackup = localStorage.getItem('mgts_last_backup');
              if (!lastBackup || (Date.now() - parseInt(lastBackup)) > 1800000) {
                setShowBackupReminder(true);
              }
            }, 1800000);

            return () => clearInterval(backupCheck);
          }, []);

          useEffect(() => {
            if (Object.keys(evidenceData).length > 0 && !showUserPrompt) {
              saveData();
            }
          }, [evidenceData]);

          const initializeData = () => {
            const initialData = {};
            Object.keys(OFSTED_FRAMEWORK).forEach(sectionKey => {
              initialData[sectionKey] = {
                criteria: OFSTED_FRAMEWORK[sectionKey].criteria.map(c => ({
                  criterion: c,
                  evidence: [],
                  rag: 'red'
                }))
              };
            });
            setEvidenceData(initialData);
          };

          const saveData = () => {
            const dataToSave = {
              data: evidenceData,
              timestamp: new Date().toISOString()
            };
            localStorage.setItem('mgts_ofsted_evidence', JSON.stringify(dataToSave));
            setLastSaved(new Date());
          };

          const exportData = () => {
            const dataStr = JSON.stringify({ data: evidenceData, timestamp: new Date().toISOString() }, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `mgts_ofsted_backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            localStorage.setItem('mgts_last_backup', Date.now().toString());
            setShowBackupReminder(false);
          };

          const importData = (event) => {
            const file = event.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = (e) => {
                try {
                  const imported = JSON.parse(e.target.result);
                  setEvidenceData(imported.data);
                  setLastSaved(new Date(imported.timestamp));
                  alert('Data imported successfully!');
                } catch (error) {
                  alert('Error importing data. Please check the file format.');
                }
              };
              reader.readAsText(file);
            }
          };

          const handleUserSubmit = () => {
            if (currentUser.trim()) {
              localStorage.setItem('mgts_current_user', currentUser);
              setShowUserPrompt(false);
            }
          };

          const handleApiKeySubmit = () => {
            if (tempApiKey.trim().startsWith('sk-ant-')) {
              setApiKey(tempApiKey.trim());
              setShowApiKeyPrompt(false);
              setShowApiKeySettings(false);
              setTempApiKey('');
            } else {
              alert('Please enter a valid Anthropic API key (starts with sk-ant-)');
            }
          };

          const generateProfessionalStatement = async (sectionKey, criterionIndex) => {
            if (!newEvidence.description || !newEvidence.evidence) {
              alert("Please fill in both description and evidence fields");
              return;
            }

            if (!apiKey) {
              alert("API key not configured. Please enter your API key.");
              setShowApiKeySettings(true);
              return;
            }

            setIsGenerating(true);

            try {
              const response = await fetch("https://api.anthropic.com/v1/messages", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  "x-api-key": apiKey,
                  "anthropic-version": "2023-06-01"
                },
                body: JSON.stringify({
                  model: "claude-sonnet-4-20250514",
                  max_tokens: 500,
                  messages: [
                    {
                      role: "user",
                      content: `Context:
- Ofsted Evaluation Area: ${OFSTED_FRAMEWORK[sectionKey].title}
- Specific Criterion: ${OFSTED_FRAMEWORK[sectionKey].criteria[criterionIndex]}

Staff Input:
What we do: ${newEvidence.description}
Evidence: ${newEvidence.evidence}

Task: Transform this into a professional, third-person evidence statement suitable for an Ofsted inspection evidence file. Write as if documenting established organisational practice. Be specific, use evidence-based language, and maintain professional tone. Keep it concise (2-3 sentences maximum).

Format your response as a single paragraph without any preamble or metadata.`
                    }
                  ]
                })
              });

              if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error?.message || 'API request failed');
              }

              const data = await response.json();
              const professionalResponse = data.content[0].text.trim();

              const updatedData = { ...evidenceData };
              updatedData[sectionKey].criteria[criterionIndex].evidence.push({
                id: Date.now(),
                description: newEvidence.description,
                rawEvidence: newEvidence.evidence,
                professionalStatement: professionalResponse,
                links: newEvidence.links.split('\n').filter(l => l.trim()),
                dateAdded: new Date().toISOString(),
                addedBy: currentUser
              });

              const evidenceCount = updatedData[sectionKey].criteria[criterionIndex].evidence.length;
              if (evidenceCount >= 3) {
                updatedData[sectionKey].criteria[criterionIndex].rag = 'green';
              } else if (evidenceCount >= 1) {
                updatedData[sectionKey].criteria[criterionIndex].rag = 'amber';
              }

              setEvidenceData(updatedData);
              setNewEvidence({ description: '', evidence: '', links: '' });
              setShowAddEvidence(null);
            } catch (error) {
              console.error("Error generating professional statement:", error);
              alert(`Error: ${error.message}. Please check your API key and try again.`);
            } finally {
              setIsGenerating(false);
            }
          };

          const updateRAG = (sectionKey, criterionIndex, rag) => {
            const updatedData = { ...evidenceData };
            updatedData[sectionKey].criteria[criterionIndex].rag = rag;
            setEvidenceData(updatedData);
          };

          const calculateSectionRAG = (sectionKey) => {
            const section = evidenceData[sectionKey];
            if (!section) return 'red';

            const ragCounts = { red: 0, amber: 0, green: 0 };
            section.criteria.forEach(c => {
              ragCounts[c.rag]++;
            });

            const total = section.criteria.length;
            const greenPercent = (ragCounts.green / total) * 100;
            const redPercent = (ragCounts.red / total) * 100;

            if (redPercent > 25) return 'red';
            if (greenPercent >= 75) return 'green';
            return 'amber';
          };

          const getSectionGrade = (sectionKey) => {
            const sectionRAG = calculateSectionRAG(sectionKey);
            const section = OFSTED_FRAMEWORK[sectionKey];

            if (section.type === 'binary') {
              return sectionRAG === 'green' ? 'MET' : (sectionRAG === 'amber' ? 'LIKELY TO MEET' : 'NOT MET');
            } else {
              if (sectionRAG === 'green') return section.grades[2];
              if (sectionRAG === 'amber') return section.grades[1];
              return section.grades[0];
            }
          };

          const generateSelfAssessment = async () => {
            if (!apiKey) {
              alert("API key not configured. Please enter your API key.");
              setShowApiKeySettings(true);
              return;
            }

            setIsGenerating(true);
            setShowReport(true);

            try {
              const sections = Object.keys(OFSTED_FRAMEWORK);
              const reportSections = {};

              for (const sectionKey of sections) {
                const section = OFSTED_FRAMEWORK[sectionKey];
                const sectionData = evidenceData[sectionKey];
                const grade = getSectionGrade(sectionKey);

                let evidenceSummary = '';
                sectionData.criteria.forEach((criterion, idx) => {
                  if (criterion.evidence.length > 0) {
                    evidenceSummary += `\n\nCriterion: ${criterion.criterion}\n`;
                    evidenceSummary += `Evidence:\n`;
                    criterion.evidence.forEach(ev => {
                      evidenceSummary += `- ${ev.professionalStatement}\n`;
                    });
                  }
                });

                const response = await fetch("https://api.anthropic.com/v1/messages", {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                    "x-api-key": apiKey,
                    "anthropic-version": "2023-06-01"
                  },
                  body: JSON.stringify({
                    model: "claude-sonnet-4-20250514",
                    max_tokens: 2000,
                    messages: [
                      {
                        role: "user",
                        content: `You are writing a self-assessment report section for Midlands Group Training Services (MGTS) for Ofsted inspection preparation.

Evaluation Area: ${section.title}
Current Grade Assessment: ${grade}

Evidence Summary:
${evidenceSummary || 'Limited evidence currently documented for this section.'}

Task: Write a professional, evaluative narrative for this section of the self-assessment report. Include:
1. Brief overview of current position (2-3 sentences)
2. Key strengths with reference to evidence (bullet points)
3. Areas for development/improvement (bullet points)
4. Justification for the ${grade} grade

Write in third person, professional tone, suitable for an Ofsted self-assessment report. Be honest about strengths and areas for improvement. Maximum 300 words.`
                      }
                    ]
                  })
                });

                if (!response.ok) {
                  throw new Error('Failed to generate section');
                }

                const data = await response.json();
                reportSections[sectionKey] = {
                  title: section.title,
                  grade: grade,
                  narrative: data.content[0].text.trim()
                };
              }

              const overallResponse = await fetch("https://api.anthropic.com/v1/messages", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  "x-api-key": apiKey,
                  "anthropic-version": "2023-06-01"
                },
                body: JSON.stringify({
                  model: "claude-sonnet-4-20250514",
                  max_tokens: 1500,
                  messages: [
                    {
                      role: "user",
                      content: `You are writing the executive summary for Midlands Group Training Services (MGTS) Ofsted self-assessment report.

Section Grades:
${Object.keys(reportSections).map(key => `- ${reportSections[key].title}: ${reportSections[key].grade}`).join('\n')}

Task: Write a professional executive summary (200-250 words) that:
1. States the overall effectiveness grade (typically the most common grade across sections, with safeguarding as critical)
2. Provides brief rationale
3. Highlights key strengths across the provision
4. Identifies strategic priorities for improvement
5. Concludes with confidence statement for inspection readiness

Write in professional, evaluative tone suitable for senior leadership and trustees.`
                    }
                  ]
                })
              });

              if (!overallResponse.ok) {
                throw new Error('Failed to generate executive summary');
              }

              const overallData = await overallResponse.json();

              setGeneratedReport({
                date: new Date().toISOString(),
                sections: reportSections,
                executiveSummary: overallData.content[0].text.trim()
              });

            } catch (error) {
              console.error("Error generating report:", error);
              alert(`Error generating self-assessment report: ${error.message}`);
            } finally {
              setIsGenerating(false);
            }
          };

          const generateActionPlan = async () => {
            if (!apiKey) {
              alert("API key not configured. Please enter your API key.");
              setShowApiKeySettings(true);
              return;
            }

            setIsGenerating(true);

            try {
              // Collect all RED and AMBER criteria
              const priorities = [];
              Object.keys(OFSTED_FRAMEWORK).forEach(sectionKey => {
                const section = OFSTED_FRAMEWORK[sectionKey];
                const sectionData = evidenceData[sectionKey];
                
                sectionData.criteria.forEach((criterion, idx) => {
                  if (criterion.rag === 'red' || criterion.rag === 'amber') {
                    priorities.push({
                      section: section.title,
                      criterion: criterion.criterion,
                      rag: criterion.rag,
                      evidenceCount: criterion.evidence.length
                    });
                  }
                });
              });

              if (priorities.length === 0) {
                setActionPlan({
                  date: new Date().toISOString(),
                  message: "Excellent progress! All criteria are currently rated GREEN. Continue to maintain and strengthen your evidence base."
                });
                setIsGenerating(false);
                return;
              }

              const response = await fetch("https://api.anthropic.com/v1/messages", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  "x-api-key": apiKey,
                  "anthropic-version": "2023-06-01"
                },
                body: JSON.stringify({
                  model: "claude-sonnet-4-20250514",
                  max_tokens: 2500,
                  messages: [
                    {
                      role: "user",
                      content: `You are creating an action plan for Midlands Group Training Services (MGTS) to improve their Ofsted inspection readiness.

Priority Areas Requiring Action:

${priorities.map((p, i) => `${i + 1}. [${p.rag.toUpperCase()}] ${p.section}
   Criterion: ${p.criterion}
   Current evidence items: ${p.evidenceCount}`).join('\n\n')}

Task: Create a prioritised action plan that:
1. Prioritises RED criteria first, then AMBER
2. For each priority area, provides:
   - Specific, actionable steps to gather evidence
   - Suggested evidence sources (documents, data, observations)
   - Responsible roles (e.g., Quality Manager, Senior Leadership)
   - Realistic timeframe (immediate, 1 month, 2-3 months)
   - Success criteria (what "good" looks like)

Format as a structured action plan suitable for senior leadership. Be practical and specific to education/training providers. Maximum 400 words.

Use clear headings and bullet points for readability.`
                    }
                  ]
                })
              });

              if (!response.ok) {
                throw new Error('Failed to generate action plan');
              }

              const data = await response.json();

              setActionPlan({
                date: new Date().toISOString(),
                priorities: priorities,
                actionPlan: data.content[0].text.trim()
              });

            } catch (error) {
              console.error("Error generating action plan:", error);
              alert(`Error generating action plan: ${error.message}`);
            } finally {
              setIsGenerating(false);
            }
          };

          const exportActionPlan = () => {
            if (!actionPlan) return;

            let htmlContent = `<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>MGTS Ofsted Action Plan</title>
  <style>
    body { font-family: Arial, sans-serif; line-height: 1.6; max-width: 210mm; margin: 0 auto; padding: 20mm; }
    h1 { color: #1e40af; border-bottom: 3px solid #1e40af; padding-bottom: 10px; }
    h2 { color: #1e40af; margin-top: 30px; }
    .header { text-align: center; margin-bottom: 30px; }
    .priority-red { background-color: #fee2e2; border-left: 4px solid #dc2626; padding: 10px; margin: 10px 0; }
    .priority-amber { background-color: #fef3c7; border-left: 4px solid #f59e0b; padding: 10px; margin: 10px 0; }
    .action-plan { background-color: #f9fafb; padding: 20px; border-radius: 8px; margin: 20px 0; }
  </style>
</head>
<body>
  <div class="header">
    <h1>MIDLANDS GROUP TRAINING SERVICES (MGTS)</h1>
    <h2>OFSTED READINESS ACTION PLAN</h2>
    <p><strong>Generated:</strong> ${new Date(actionPlan.date).toLocaleDateString('en-GB')}</p>
  </div>

  ${actionPlan.message ? `<p>${actionPlan.message}</p>` : `
  <h2>Priority Areas (${actionPlan.priorities.length})</h2>
  ${actionPlan.priorities.map(p => `
  <div class="priority-${p.rag}">
    <strong>[${p.rag.toUpperCase()}]</strong> ${p.section}<br>
    <em>${p.criterion}</em><br>
    Current evidence: ${p.evidenceCount} item(s)
  </div>
  `).join('')}

  <div class="action-plan">
    <h2>Action Plan</h2>
    ${actionPlan.actionPlan.replace(/\n/g, '<br>')}
  </div>
  `}

</body>
</html>`;

            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `MGTS_Action_Plan_${new Date().toISOString().split('T')[0]}.html`;
            a.click();
          };

          const exportReportToPDF = () => {
            if (!generatedReport) return;

            let htmlContent = `<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>MGTS Ofsted Self-Assessment Report</title>
  <style>
    body { font-family: Arial, sans-serif; line-height: 1.6; max-width: 210mm; margin: 0 auto; padding: 20mm; }
    h1 { color: #1e40af; border-bottom: 3px solid #1e40af; padding-bottom: 10px; }
    h2 { color: #1e40af; margin-top: 30px; border-bottom: 2px solid #ddd; padding-bottom: 5px; }
    .header { text-align: center; margin-bottom: 30px; }
    .grade { display: inline-block; padding: 5px 15px; border-radius: 5px; font-weight: bold; margin-left: 10px; }
    .grade-met { background-color: #d1fae5; color: #065f46; }
    .grade-strong { background-color: #d1fae5; color: #065f46; }
    .grade-expected { background-color: #dbeafe; color: #1e40af; }
    .grade-needs { background-color: #fee2e2; color: #991b1b; }
    .executive-summary { background-color: #eff6ff; padding: 20px; border-radius: 8px; margin: 20px 0; }
    .section { margin: 30px 0; }
  </style>
</head>
<body>
  <div class="header">
    <h1>MIDLANDS GROUP TRAINING SERVICES (MGTS)</h1>
    <h2>OFSTED SELF-ASSESSMENT REPORT</h2>
    <p><strong>Generated:</strong> ${new Date(generatedReport.date).toLocaleDateString('en-GB')}</p>
  </div>

  <div class="executive-summary">
    <h2>Executive Summary</h2>
    <p>${generatedReport.executiveSummary.replace(/\n/g, '<br>')}</p>
  </div>

  <h2>Detailed Evaluation Areas</h2>
`;

            Object.keys(generatedReport.sections).forEach(sectionKey => {
              const section = generatedReport.sections[sectionKey];
              const gradeClass = section.grade.includes('Strong') || section.grade.includes('MET') ? 'grade-strong' :
                                section.grade.includes('Expected') ? 'grade-expected' : 'grade-needs';

              htmlContent += `
  <div class="section">
    <h2>${section.title} <span class="${gradeClass} grade">${section.grade}</span></h2>
    <p>${section.narrative.replace(/\n/g, '<br>')}</p>
  </div>
`;
            });

            htmlContent += `
</body>
</html>`;

            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `MGTS_Self_Assessment_${new Date().toISOString().split('T')[0]}.html`;
            a.click();
          };

          const RAGIndicator = ({ rag }) => {
            const colors = {
              red: 'bg-red-500',
              amber: 'bg-amber-500',
              green: 'bg-green-500'
            };
            return <div className={`w-4 h-4 rounded-full ${colors[rag]}`}></div>;
          };

          // API Key Prompt Modal
          if (showApiKeyPrompt) {
            return (
              <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
                <div className="bg-white rounded-lg shadow-xl p-8 max-w-2xl w-full">
                  <div className="text-center mb-6">
                    <h1 className="text-2xl font-bold text-gray-900 mb-2">Claude API Key Required</h1>
                    <p className="text-gray-600 mb-4">This app uses Claude AI to generate professional statements and reports. You'll need your own Anthropic API key.</p>
                  </div>
                  
                  <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4 text-sm">
                    <h3 className="font-semibold mb-2">How to get your API key:</h3>
                    <ol className="list-decimal ml-5 space-y-1">
                      <li>Go to <a href="https://console.anthropic.com/" target="_blank" className="text-blue-600 underline">console.anthropic.com</a></li>
                      <li>Sign up or log in</li>
                      <li>Navigate to "API Keys"</li>
                      <li>Create a new API key</li>
                      <li>Copy and paste it below</li>
                    </ol>
                    <p className="mt-2 text-gray-700"><strong>Note:</strong> You'll need to add credit (minimum £5). Estimated cost for this app: ~£1-2 for full use.</p>
                  </div>

                  <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4 text-sm">
                    <p className="text-yellow-800"><strong>Security:</strong> Your API key is only stored in this browser session and is never saved. You'll need to enter it each time you open this app. Keep this HTML file private.</p>
                  </div>

                  <input
                    type="password"
                    value={tempApiKey}
                    onChange={(e) => setTempApiKey(e.target.value)}
                    onKeyPress={(e) => e.key === 'Enter' && handleApiKeySubmit()}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg mb-4 font-mono text-sm"
                    placeholder="sk-ant-api03-..."
                  />
                  <button
                    onClick={handleApiKeySubmit}
                    className="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700"
                  >
                    Continue
                  </button>
                </div>
              </div>
            );
          }

          if (showUserPrompt) {
            return (
              <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
                <div className="bg-white rounded-lg shadow-xl p-8 max-w-md w-full">
                  <div className="text-center mb-6">
                    <h1 className="text-2xl font-bold text-gray-900 mb-2">Welcome to MGTS Ofsted Evidence Builder</h1>
                    <p className="text-gray-600">Please enter your name to get started</p>
                  </div>
                  <input
                    type="text"
                    value={currentUser}
                    onChange={(e) => setCurrentUser(e.target.value)}
                    onKeyPress={(e) => e.key === 'Enter' && handleUserSubmit()}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg mb-4"
                    placeholder="Your name"
                  />
                  <button
                    onClick={handleUserSubmit}
                    className="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700"
                  >
                    Start
                  </button>
                </div>
              </div>
            );
          }

          return (
            <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
              <div className="max-w-7xl mx-auto p-6">
                <div className="bg-white rounded-lg shadow-xl p-8 mb-6">
                  <div className="flex items-center justify-between mb-6">
                    <div>
                      <h1 className="text-3xl font-bold text-gray-900 mb-2">
                        MGTS Ofsted Evidence Builder & Self-Assessment System
                      </h1>
                      <p className="text-gray-600">Logged in as: {currentUser} | API Key: {apiKey ? '✓ Connected' : '✗ Not set'}</p>
                      {lastSaved && (
                        <p className="text-sm text-gray-500">Last saved: {lastSaved.toLocaleTimeString()}</p>
                      )}
                    </div>
                    <div className="flex gap-2">
                      <button 
                        onClick={() => setShowApiKeySettings(!showApiKeySettings)} 
                        className="flex items-center gap-2 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700"
                      >
                        <LucideIcon name="settings" size={20} />
                        API Key
                      </button>
                      <button onClick={exportData} className="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                        <LucideIcon name="download" size={20} />
                        Export Backup
                      </button>
                      <label className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 cursor-pointer">
                        <LucideIcon name="upload" size={20} />
                        Import
                        <input type="file" accept=".json" onChange={importData} className="hidden" />
                      </label>
                    </div>
                  </div>

                  {showApiKeySettings && (
                    <div className="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4">
                      <h3 className="font-semibold mb-2">Update API Key</h3>
                      <input
                        type="password"
                        value={tempApiKey}
                        onChange={(e) => setTempApiKey(e.target.value)}
                        className="w-full px-3 py-2 border rounded mb-2 font-mono text-sm"
                        placeholder="sk-ant-api03-..."
                      />
                      <button
                        onClick={handleApiKeySubmit}
                        className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
                      >
                        Update Key
                      </button>
                    </div>
                  )}

                  {showBackupReminder && (
                    <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4 flex items-center justify-between">
                      <div className="flex items-center gap-3">
                        <LucideIcon name="bell" size={24} className="text-yellow-600" />
                        <p className="text-yellow-800">It's been a while since your last backup. Consider exporting your data.</p>
                      </div>
                      <button onClick={() => setShowBackupReminder(false)} className="text-yellow-600 hover:text-yellow-800">
                        Dismiss
                      </button>
                    </div>
                  )}

                  <div className="flex gap-4 mb-6">
                    <button
                      onClick={() => setActiveView('evidence')}
                      className={`flex items-center gap-2 px-6 py-3 rounded-lg ${activeView === 'evidence' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'}`}
                    >
                      <LucideIcon name="file-text" size={20} />
                      Evidence Collection
                    </button>
                    <button
                      onClick={() => { setActiveView('report'); generateSelfAssessment(); }}
                      className={`flex items-center gap-2 px-6 py-3 rounded-lg ${activeView === 'report' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'}`}
                    >
                      <LucideIcon name="bar-chart-3" size={20} />
                      Generate Report
                    </button>
                    <button
                      onClick={() => { setActiveView('actionplan'); generateActionPlan(); }}
                      className={`flex items-center gap-2 px-6 py-3 rounded-lg ${activeView === 'actionplan' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'}`}
                    >
                      <LucideIcon name="trending-up" size={20} />
                      Action Plan
                    </button>
                  </div>

                  {activeView === 'evidence' && (
                    <>
                      <div className="flex gap-2 mb-6 overflow-x-auto pb-2">
                        {Object.keys(OFSTED_FRAMEWORK).map(sectionKey => {
                          const sectionRAG = calculateSectionRAG(sectionKey);
                          return (
                            <button
                              key={sectionKey}
                              onClick={() => setActiveSection(sectionKey)}
                              className={`flex items-center gap-2 px-4 py-2 rounded-lg whitespace-nowrap ${
                                activeSection === sectionKey ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700'
                              }`}
                            >
                              <RAGIndicator rag={sectionRAG} />
                              {OFSTED_FRAMEWORK[sectionKey].title.split('(')[0].trim()}
                            </button>
                          );
                        })}
                      </div>

                      <div className="bg-gray-50 rounded-lg p-6">
                        <div className="flex items-center justify-between mb-4">
                          <h2 className="text-2xl font-bold text-gray-900">
                            {OFSTED_FRAMEWORK[activeSection].title}
                          </h2>
                          <div className="text-lg font-semibold">
                            Grade: <span className="text-blue-600">{getSectionGrade(activeSection)}</span>
                          </div>
                        </div>

                        {evidenceData[activeSection]?.criteria.map((criterion, idx) => (
                          <div key={idx} className="bg-white rounded-lg p-4 mb-4 shadow">
                            <div className="flex items-start gap-3 mb-3">
                              <RAGIndicator rag={criterion.rag} />
                              <div className="flex-1">
                                <p className="font-medium text-gray-900 mb-2">{criterion.criterion}</p>
                                <div className="flex gap-2">
                                  {['red', 'amber', 'green'].map(rag => (
                                    <button
                                      key={rag}
                                      onClick={() => updateRAG(activeSection, idx, rag)}
                                      className={`px-3 py-1 text-sm rounded ${
                                        criterion.rag === rag
                                          ? `bg-${rag}-500 text-white`
                                          : `bg-${rag}-100 text-${rag}-700`
                                      }`}
                                    >
                                      {rag.toUpperCase()}
                                    </button>
                                  ))}
                                </div>
                              </div>
                              <button
                                onClick={() => setShowAddEvidence(showAddEvidence === idx ? null : idx)}
                                className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                              >
                                <LucideIcon name="plus" size={16} />
                                Add Evidence
                              </button>
                            </div>

                            {criterion.evidence.map((ev) => (
                              <div key={ev.id} className="bg-blue-50 rounded p-3 mb-2">
                                <p className="text-sm text-gray-700 mb-2">{ev.professionalStatement}</p>
                                <div className="text-xs text-gray-500">
                                  Added by {ev.addedBy} on {new Date(ev.dateAdded).toLocaleDateString()}
                                </div>
                                {ev.links.length > 0 && (
                                  <div className="mt-2">
                                    {ev.links.map((link, i) => (
                                      <a key={i} href={link} target="_blank" rel="noopener noreferrer" className="text-blue-600 text-xs block">
                                        {link}
                                      </a>
                                    ))}
                                  </div>
                                )}
                              </div>
                            ))}

                            {showAddEvidence === idx && (
                              <div className="bg-gray-50 rounded-lg p-4 mt-3">
                                <textarea
                                  value={newEvidence.description}
                                  onChange={(e) => setNewEvidence({...newEvidence, description: e.target.value})}
                                  placeholder="What do we do? (brief description)"
                                  className="w-full px-3 py-2 border rounded mb-2"
                                  rows="2"
                                />
                                <textarea
                                  value={newEvidence.evidence}
                                  onChange={(e) => setNewEvidence({...newEvidence, evidence: e.target.value})}
                                  placeholder="Evidence (documents, data, outcomes)"
                                  className="w-full px-3 py-2 border rounded mb-2"
                                  rows="3"
                                />
                                <textarea
                                  value={newEvidence.links}
                                  onChange={(e) => setNewEvidence({...newEvidence, links: e.target.value})}
                                  placeholder="Links (one per line)"
                                  className="w-full px-3 py-2 border rounded mb-3"
                                  rows="2"
                                />
                                <button
                                  onClick={() => generateProfessionalStatement(activeSection, idx)}
                                  disabled={isGenerating}
                                  className="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 disabled:bg-gray-400 flex items-center justify-center gap-2"
                                >
                                  {isGenerating ? (
                                    <>
                                      <LucideIcon name="loader" size={20} className="animate-spin" />
                                      Generating...
                                    </>
                                  ) : (
                                    <>
                                      <LucideIcon name="sparkles" size={20} />
                                      Generate Professional Statement
                                    </>
                                  )}
                                </button>
                              </div>
                            )}
                          </div>
                        ))}
                      </div>
                    </>
                  )}

                  {activeView === 'report' && (
                    <div className="bg-white rounded-lg">
                      {isGenerating && (
                        <div className="flex items-center justify-center py-12">
                          <div className="text-center">
                            <LucideIcon name="loader" size={48} className="animate-spin mx-auto mb-4 text-blue-600" />
                            <p className="text-lg text-gray-600">Generating self-assessment report...</p>
                          </div>
                        </div>
                      )}

                      {generatedReport && !isGenerating && (
                        <div>
                          <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold text-gray-900">Self-Assessment Report</h2>
                            <button
                              onClick={exportReportToPDF}
                              className="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
                            >
                              <LucideIcon name="download" size={20} />
                              Export Report
                            </button>
                          </div>

                          <div className="bg-blue-50 rounded-lg p-6 mb-6">
                            <h3 className="text-xl font-bold mb-4">Executive Summary</h3>
                            <p className="whitespace-pre-line">{generatedReport.executiveSummary}</p>
                          </div>

                          {Object.keys(generatedReport.sections).map(sectionKey => {
                            const section = generatedReport.sections[sectionKey];
                            return (
                              <div key={sectionKey} className="bg-gray-50 rounded-lg p-6 mb-4">
                                <h3 className="text-xl font-bold mb-2">
                                  {section.title}
                                  <span className="ml-3 px-3 py-1 bg-blue-600 text-white rounded text-sm">
                                    {section.grade}
                                  </span>
                                </h3>
                                <p className="whitespace-pre-line">{section.narrative}</p>
                              </div>
                            );
                          })}
                        </div>
                      )}
                    </div>
                  )}

                  {activeView === 'actionplan' && (
                    <div className="bg-white rounded-lg">
                      {isGenerating && (
                        <div className="flex items-center justify-center py-12">
                          <div className="text-center">
                            <LucideIcon name="loader" size={48} className="animate-spin mx-auto mb-4 text-blue-600" />
                            <p className="text-lg text-gray-600">Generating action plan...</p>
                          </div>
                        </div>
                      )}

                      {actionPlan && !isGenerating && (
                        <div>
                          <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold text-gray-900">Ofsted Readiness Action Plan</h2>
                            <button
                              onClick={exportActionPlan}
                              className="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
                            >
                              <LucideIcon name="download" size={20} />
                              Export Action Plan
                            </button>
                          </div>

                          {actionPlan.message ? (
                            <div className="bg-green-50 border border-green-200 rounded-lg p-6">
                              <p className="text-green-800">{actionPlan.message}</p>
                            </div>
                          ) : (
                            <>
                              <div className="bg-blue-50 rounded-lg p-6 mb-6">
                                <h3 className="text-xl font-bold mb-4">Priority Summary</h3>
                                <p className="mb-4">The following {actionPlan.priorities.length} criteria require attention:</p>
                                <div className="space-y-2">
                                  {actionPlan.priorities.map((p, i) => (
                                    <div key={i} className={`p-3 rounded border-l-4 ${
                                      p.rag === 'red' ? 'bg-red-50 border-red-500' : 'bg-amber-50 border-amber-500'
                                    }`}>
                                      <div className="font-semibold">[{p.rag.toUpperCase()}] {p.section}</div>
                                      <div className="text-sm text-gray-700">{p.criterion}</div>
                                      <div className="text-xs text-gray-500 mt-1">Current evidence: {p.evidenceCount} item(s)</div>
                                    </div>
                                  ))}
                                </div>
                              </div>

                              <div className="bg-gray-50 rounded-lg p-6">
                                <h3 className="text-xl font-bold mb-4">Recommended Actions</h3>
                                <div className="prose max-w-none whitespace-pre-line">
                                  {actionPlan.actionPlan}
                                </div>
                              </div>
                            </>
                          )}
                        </div>
                      )}
                    </div>
                  )}
                </div>
              </div>
            </div>
          );
        };

        ReactDOM.render(<OfstedEvidenceBuilder />, document.getElementById('root'));
    </script>
</body>
</html>